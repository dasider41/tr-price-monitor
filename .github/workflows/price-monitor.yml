name: Price Monitor

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ (UTC ê¸°ì¤€, ë‰´ì§ˆëœë“œ ì‹œê°„ ì˜¤í›„ 10ì‹œê²½)ì— ì‹¤í–‰
    - cron: '0 9 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  check-price:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        pip install requests beautifulsoup4 lxml playwright
        playwright install chromium
        playwright install-deps
        
    - name: Check price and send email
      env:
        EMAIL_TO: dasider41@gmail.com
        SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
      run: |
        python << 'EOF'
        import json
        import os
        import re
        from datetime import datetime
        from playwright.sync_api import sync_playwright
        import requests

        # ì›¹ì‚¬ì´íŠ¸ì—ì„œ ê°€ê²© ê°€ì ¸ì˜¤ê¸°
        def get_current_price():
            url = "https://www.truerewards.co.nz/merchandise/Technology/TC7493"
            
            try:
                with sync_playwright() as p:
                    browser = p.chromium.launch(headless=True)
                    page = browser.new_page()
                    
                    # í˜ì´ì§€ ë¡œë“œ
                    page.goto(url, timeout=30000)
                    
                    # JavaScriptê°€ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
                    page.wait_for_timeout(5000)
                    
                    # ì •í™•í•œ ê°€ê²© ì„ íƒìë¡œ ê°€ê²© ì°¾ê¸°
                    price_selector = '#content > section > div.tr-fixed-container.product-detail > div:nth-child(2) > div.col-md-10.col-lg-25.col-md-no-padding > div > div > div > div.aciem-not-special-or-deal.yellow-text > span > span'
                    
                    try:
                        # ê°€ê²© ìš”ì†Œê°€ ë‚˜íƒ€ë‚  ë•Œê¹Œì§€ ëŒ€ê¸°
                        page.wait_for_selector(price_selector, timeout=10000)
                        
                        # ê°€ê²© í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
                        price_element = page.query_selector(price_selector)
                        if price_element:
                            price_text = price_element.inner_text().strip()
                            print(f"Found price text: {price_text}")
                            
                            # ìˆ«ìë§Œ ì¶”ì¶œ (TR$, $, ì‰¼í‘œ ì œê±°)
                            price_text = price_text.replace('TR

        # ì´ì „ ê°€ê²© ë¶ˆëŸ¬ì˜¤ê¸°
        def load_previous_price():
            try:
                with open('price_history.json', 'r') as f:
                    data = json.load(f)
                    return data.get('price')
            except FileNotFoundError:
                return 349.00  # ì´ˆê¸° ê°€ê²©

        # ê°€ê²© ì €ì¥
        def save_price(price):
            data = {
                'price': price,
                'last_checked': datetime.now().isoformat()
            }
            with open('price_history.json', 'w') as f:
                json.dump(data, f)

        # SendGridë¡œ ì´ë©”ì¼ ë³´ë‚´ê¸°
        def send_email(old_price, new_price):
            api_key = os.environ.get('SENDGRID_API_KEY')
            if not api_key:
                print("SendGrid API key not found")
                return
            
            email_to = os.environ.get('EMAIL_TO')
            
            data = {
                "personalizations": [{
                    "to": [{"email": email_to}],
                    "subject": "ğŸ”” ê°€ê²© ë³€ë™ ì•Œë¦¼ - True Rewards"
                }],
                "from": {"email": "noreply@github.com"},
                "content": [{
                    "type": "text/html",
                    "value": f"""
                    <h2>ê°€ê²©ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!</h2>
                    <p><strong>ì œí’ˆ:</strong> True Rewards TC7493</p>
                    <p><strong>ì´ì „ ê°€ê²©:</strong> ${old_price:.2f}</p>
                    <p><strong>í˜„ì¬ ê°€ê²©:</strong> ${new_price:.2f}</p>
                    <p><strong>ë³€ë™:</strong> ${new_price - old_price:.2f}</p>
                    <p><a href="https://www.truerewards.co.nz/merchandise/Technology/TC7493">ì œí’ˆ ë³´ëŸ¬ ê°€ê¸°</a></p>
                    <p><small>í™•ì¸ ì‹œê°„: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</small></p>
                    """
                }]
            }
            
            headers = {
                'Authorization': f'Bearer {api_key}',
                'Content-Type': 'application/json'
            }
            
            try:
                response = requests.post(
                    'https://api.sendgrid.com/v3/mail/send',
                    headers=headers,
                    json=data
                )
                if response.status_code == 202:
                    print("Email sent successfully")
                else:
                    print(f"Failed to send email: {response.status_code}")
            except Exception as e:
                print(f"Error sending email: {e}")

        # ë©”ì¸ ë¡œì§
        current_price = get_current_price()
        
        if current_price is None:
            print("Could not fetch current price")
            exit(1)
        
        print(f"Current price: ${current_price:.2f}")
        
        previous_price = load_previous_price()
        print(f"Previous price: ${previous_price:.2f}")
        
        if current_price != previous_price:
            print("Price changed! Sending email...")
            send_email(previous_price, current_price)
            save_price(current_price)
        else:
            print("Price unchanged")
            save_price(current_price)
        
        EOF
        
    - name: Commit price history
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add price_history.json
        git add page_screenshot.png || true
        git diff --quiet && git diff --staged --quiet || git commit -m "Update price history [skip ci]"
        
    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}, '').replace('

        # ì´ì „ ê°€ê²© ë¶ˆëŸ¬ì˜¤ê¸°
        def load_previous_price():
            try:
                with open('price_history.json', 'r') as f:
                    data = json.load(f)
                    return data.get('price')
            except FileNotFoundError:
                return 349.00  # ì´ˆê¸° ê°€ê²©

        # ê°€ê²© ì €ì¥
        def save_price(price):
            data = {
                'price': price,
                'last_checked': datetime.now().isoformat()
            }
            with open('price_history.json', 'w') as f:
                json.dump(data, f)

        # SendGridë¡œ ì´ë©”ì¼ ë³´ë‚´ê¸°
        def send_email(old_price, new_price):
            api_key = os.environ.get('SENDGRID_API_KEY')
            if not api_key:
                print("SendGrid API key not found")
                return
            
            email_to = os.environ.get('EMAIL_TO')
            
            data = {
                "personalizations": [{
                    "to": [{"email": email_to}],
                    "subject": "ğŸ”” ê°€ê²© ë³€ë™ ì•Œë¦¼ - True Rewards"
                }],
                "from": {"email": "noreply@github.com"},
                "content": [{
                    "type": "text/html",
                    "value": f"""
                    <h2>ê°€ê²©ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!</h2>
                    <p><strong>ì œí’ˆ:</strong> True Rewards TC7493</p>
                    <p><strong>ì´ì „ ê°€ê²©:</strong> ${old_price:.2f}</p>
                    <p><strong>í˜„ì¬ ê°€ê²©:</strong> ${new_price:.2f}</p>
                    <p><strong>ë³€ë™:</strong> ${new_price - old_price:.2f}</p>
                    <p><a href="https://www.truerewards.co.nz/merchandise/Technology/TC7493">ì œí’ˆ ë³´ëŸ¬ ê°€ê¸°</a></p>
                    <p><small>í™•ì¸ ì‹œê°„: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</small></p>
                    """
                }]
            }
            
            headers = {
                'Authorization': f'Bearer {api_key}',
                'Content-Type': 'application/json'
            }
            
            try:
                response = requests.post(
                    'https://api.sendgrid.com/v3/mail/send',
                    headers=headers,
                    json=data
                )
                if response.status_code == 202:
                    print("Email sent successfully")
                else:
                    print(f"Failed to send email: {response.status_code}")
            except Exception as e:
                print(f"Error sending email: {e}")

        # ë©”ì¸ ë¡œì§
        current_price = get_current_price()
        
        if current_price is None:
            print("Could not fetch current price")
            exit(1)
        
        print(f"Current price: ${current_price:.2f}")
        
        previous_price = load_previous_price()
        print(f"Previous price: ${previous_price:.2f}")
        
        if current_price != previous_price:
            print("Price changed! Sending email...")
            send_email(previous_price, current_price)
            save_price(current_price)
        else:
            print("Price unchanged")
            save_price(current_price)
        
        EOF
        
    - name: Commit price history
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add price_history.json
        git add page_screenshot.png || true
        git diff --quiet && git diff --staged --quiet || git commit -m "Update price history [skip ci]"
        
    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}, '').replace(',', '').strip()
                            
                            try:
                                price = float(price_text)
                                print(f"Extracted price: ${price:.2f}")
                                browser.close()
                                return price
                            except ValueError:
                                print(f"Could not convert '{price_text}' to float")
                    
                    except Exception as e:
                        print(f"Price element not found: {e}")
                    
                    # ìŠ¤í¬ë¦°ìƒ· ì €ì¥ (ë””ë²„ê¹…ìš©)
                    page.screenshot(path='page_screenshot.png', full_page=True)
                    print("Could not find price")
                    
                    browser.close()
                    return None
                    
            except Exception as e:
                print(f"Error fetching price: {e}")
                import traceback
                traceback.print_exc()
                return None

        # ì´ì „ ê°€ê²© ë¶ˆëŸ¬ì˜¤ê¸°
        def load_previous_price():
            try:
                with open('price_history.json', 'r') as f:
                    data = json.load(f)
                    return data.get('price')
            except FileNotFoundError:
                return 349.00  # ì´ˆê¸° ê°€ê²©

        # ê°€ê²© ì €ì¥
        def save_price(price):
            data = {
                'price': price,
                'last_checked': datetime.now().isoformat()
            }
            with open('price_history.json', 'w') as f:
                json.dump(data, f)

        # SendGridë¡œ ì´ë©”ì¼ ë³´ë‚´ê¸°
        def send_email(old_price, new_price):
            api_key = os.environ.get('SENDGRID_API_KEY')
            if not api_key:
                print("SendGrid API key not found")
                return
            
            email_to = os.environ.get('EMAIL_TO')
            
            data = {
                "personalizations": [{
                    "to": [{"email": email_to}],
                    "subject": "ğŸ”” ê°€ê²© ë³€ë™ ì•Œë¦¼ - True Rewards"
                }],
                "from": {"email": "noreply@github.com"},
                "content": [{
                    "type": "text/html",
                    "value": f"""
                    <h2>ê°€ê²©ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!</h2>
                    <p><strong>ì œí’ˆ:</strong> True Rewards TC7493</p>
                    <p><strong>ì´ì „ ê°€ê²©:</strong> ${old_price:.2f}</p>
                    <p><strong>í˜„ì¬ ê°€ê²©:</strong> ${new_price:.2f}</p>
                    <p><strong>ë³€ë™:</strong> ${new_price - old_price:.2f}</p>
                    <p><a href="https://www.truerewards.co.nz/merchandise/Technology/TC7493">ì œí’ˆ ë³´ëŸ¬ ê°€ê¸°</a></p>
                    <p><small>í™•ì¸ ì‹œê°„: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}</small></p>
                    """
                }]
            }
            
            headers = {
                'Authorization': f'Bearer {api_key}',
                'Content-Type': 'application/json'
            }
            
            try:
                response = requests.post(
                    'https://api.sendgrid.com/v3/mail/send',
                    headers=headers,
                    json=data
                )
                if response.status_code == 202:
                    print("Email sent successfully")
                else:
                    print(f"Failed to send email: {response.status_code}")
            except Exception as e:
                print(f"Error sending email: {e}")

        # ë©”ì¸ ë¡œì§
        current_price = get_current_price()
        
        if current_price is None:
            print("Could not fetch current price")
            exit(1)
        
        print(f"Current price: ${current_price:.2f}")
        
        previous_price = load_previous_price()
        print(f"Previous price: ${previous_price:.2f}")
        
        if current_price != previous_price:
            print("Price changed! Sending email...")
            send_email(previous_price, current_price)
            save_price(current_price)
        else:
            print("Price unchanged")
            save_price(current_price)
        
        EOF
        
    - name: Commit price history
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add price_history.json
        git add page_screenshot.png || true
        git diff --quiet && git diff --staged --quiet || git commit -m "Update price history [skip ci]"
        
    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}
